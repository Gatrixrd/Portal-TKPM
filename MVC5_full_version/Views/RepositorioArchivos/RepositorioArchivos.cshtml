@model ClickFactura_Entidades.BD.Modelos.repositorioArchivosModel
@using Kendo.Mvc.UI
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.4.0/jszip.min.js"></script>
    <script src="../Scripts/JsZip/jszip.js"></script>
    <script src="../Scripts/JsZip/jszip.min.js"></script>
    <script src="../Scripts/JsZip/FileSaver.js"></script>
    <link rel="stylesheet" href="~/Content/kendo/kendo.common.min.css" />
    <link rel="stylesheet" href="~/Content/kendo/kendo.default.min.css" />
    <link rel="stylesheet" href="~/Content/kendo/kendo.default.mobile.min.css" />
   @Html.Hidden("RedirectToAlmacenamientoInterno", Url.Action("AlmacenamientoInterno", "AlmacenamientoInterno"))
   <script src="~/Content/pako.min.js"></script>
 
            <style >
                 .demo-section p {
                    margin: 3px 0 20px;
                    line-height: 50px;
                }
                .demo-section .k-button {
                    width: 250px;
                }

                .k-notification {
                    border: 0;
                }


                /* Info template */
                .k-notification-info.k-group {
                    background: rgba(0%,0%,0%,.7);
                    color: #fff;
                }
                .new-mail {
                    width: 300px;
                    height: 100px;
                }
                .new-mail h3 {
                    font-size: 1em;
                    padding: 32px 10px 5px;
                }
                .new-mail img {
                    float: left;
                    margin: 30px 15px 30px 30px;
                }

                /* Error template */
                .k-notification-error.k-group {
                    background: rgba(100%,0%,0%,.7);
                    color: #ffffff;
                }
                .wrong-pass {
                    width: 300px;
                    height: 100px;
                }
                .wrong-pass h3 {
                    font-size: 1em;
                    padding: 32px 10px 5px;
                }
                .wrong-pass img {
                    float: left;
                    margin: 30px 15px 30px 30px;
                }

                /* Success template */
                .k-notification-upload-success.k-group {
                    background: rgba(0%,60%,0%,.7);
                    color: #fff;
                }
                .upload-success {
                    width: 240px;
                    height: 100px;
                    padding: 0 30px;
                    line-height: 100px;
                }
                .upload-success h3 {
                    font-size: 1.7em;
                    font-weight: normal;
                    display: inline-block;
                    vertical-align: middle;
                }
                .upload-success img {
                    display: inline-block;
                    vertical-align: middle;
                    margin-right: 10px;
                }
                .fieldlist {
                    margin: 0 0 -1em;
                    padding: 0;
                }

                .fieldlist li {
                    list-style: none;
                    padding-bottom: 1em;
                }

               .dropdown-header {
                   border-width: 0 0 1px 0;
                   text-transform: uppercase;
               }

               .dropdown-header > span {
                   display: inline-block;
                   padding: 10px;
               }

               .dropdown-header > span:first-child {
                   width: 50px;
               }

               #customers-list .k-item {
                   line-height: 1em;
                   min-width: 300px;
               }
    
               /* Material Theme padding adjustment*/
    
               .k-material #customers-list .k-item,
               .k-material #customers-list .k-item.k-state-hover,
               .k-materialblack #customers-list .k-item,
               .k-materialblack #customers-list .k-item.k-state-hover {
                   padding-left: 5px;
                   border-left: 0;
               }

               #customers-list .k-item > span {
                   -webkit-box-sizing: border-box;
                   -moz-box-sizing: border-box;
                   box-sizing: border-box;
                   display: inline-block;
                   vertical-align: top;
                   margin: 20px 10px 10px 5px;
               }

               #customers-list .k-item > span:first-child {
                   -moz-box-shadow: inset 0 0 30px rgba(0,0,0,.3);
                   -webkit-box-shadow: inset 0 0 30px rgba(0,0,0,.3);
                   box-shadow: inset 0 0 30px rgba(0,0,0,.3);
                   margin: 10px;
                   width: 50px;
                   height: 50px;
                   border-radius: 50%;
                   background-size: 100%;
                   background-repeat: no-repeat;
               }

               #customers-list h3 {
                   font-size: 1.2em;
                   font-weight: normal;
                   margin: 0 0 1px 0;
                   padding: 0;
               }

               #customers-list p {
                   margin: 0;
                   padding: 0;
                   font-size: .8em;
               }

            </style>

<!--ENCABEZADO-->
<div class="pageheader">
    <h1>Repositorio de archivos </h1>
    <p id="tipoReporte" class="description"></p>
    <div class="breadcrumb-wrapper hidden-xs">
        <span class="label">Esta aqui:</span>
        <ol class="breadcrumb">
            <li>
                <a href="index.html">Inicio</a>
            </li>
            <li>Sistema</li>
            <li class="active">Repositorio archivos</li>
        </ol>
    </div>
 </div>
<br />


<!--CUERPO-->
<form role="form">
    <!--FILTROS-->
    <div id="Filtros">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Filtros</h3>
                    <div class="actions pull-right">
                        <i class="fa fa-expand"></i>
                        <i class="fa fa-chevron-down"></i>
                        <i class="fa fa-times"></i>
                    </div>
                </div>
                <div class="panel-body">
                    <table style="width:100%;">
                        <tr>
                            <td style="width:40%">
                                <div class="form-group">
                                    <div id="Sociedad">
                                        <label for="sociedades" class="col-xs-3 col-sm-12 col-md-8 col-lg-12 control-label">Sociedades </label>
                                        <div class="col-sm-10">
                                            <select class="form-control" id="Sociedades" name="Sociedades" placeholder="Seleccione"></select>
                                        </div>
                                    </div>
                                </div>

                                @*<div class="form-group">
                                    <div id="Documento">
                                        <label for="documentos" class="col-sm-12 control-label">Tipo de documentos </label>
                                        <div class="col-sm-10">
                                            <select class="form-control" id="Documentos" name="Documentos" placeholder="Seleccione" runat="server"></select>
                                        </div>
                                    </div>
                                </div>*@

                                <div class="form-group">
                                    <label for="lblRFC_Proveedor" class="col-sm-12 control-label">RFC del proveedor </label>
                                    <div class="col-sm-10">
                                        <input type="text" class="col-sm-12 control-label" id="txtRFC_Proveedor" name="txtRFC_Proveedor" placeholder="Escriba RFC del proveedor">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="lblRFC_Proveedor" class="col-sm-12 control-label">Orden de Compra </label>
                                    <div class="col-sm-10">
                                        <input type="text" class="col-sm-12 control-label" id="txtOrdenCompra" name="txtOrdenCompra" placeholder="Escriba una Orden de Compra">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="lblNum_Proveedor" class="col-sm-12 control-label">No. de Proveedor </label>
                                    <div class="col-sm-10">
                                        <input type="text" class="col-sm-12 control-label" id="txtNum_Proveedor" name="txtNum_Proveedor" placeholder="Escriba numero de proveedor">
                                    </div>
                                </div>
                                <!--############################################################################################################################################-->
                               <div class="form-group">
                                <label for="lblTipoOrden" class="col-sm-12 control-label">Indique un tipo de orden relacionado. </label>
                                  <div class="col-sm-10">
                                                                  <div class="demo-section k-content">
                                                                    @(Html.Kendo().ComboBox().Name("estatus")
                                                                          .BindTo(new SelectList(new[] {  new { Key = "Todos", Value = "iconTodosDocumentos.gif" }, new { Key = "Verificada", Value = "PasivoOk.gif" }, new { Key = "Rechazado", Value = "PasivoDeny.gif" } }, "Value", "Key", new { Key = "iconTodosDocumentos.png", Value = "Todos" }))
                                                                          .DataTextField("Text")
                                                                          .DataValueField("Value")
                                                                          .Value("Todos")
                                                                          .Filter(FilterType.Contains)
                                                                          .Suggest(true))
                                                               </div>
                                   </div>
                              </div>
                               <!--############################################################################################################################################-->
                            </td>
                            <td  style="width:40%">

                                <div class="form-group">
                                    <label for="lblUUID" class="col-sm-12 control-label">Nombre del archivo </label>
                                    <div class="col-sm-10">
                                        <input type="text" class="col-sm-12 control-label" id="txtNombre" name="txtNombre" placeholder="Escriba nombre o parte del nombre del archivo">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="lblUUID" class="col-sm-12 control-label">UUID de la Factura </label>
                                    <div class="col-sm-10">
                                        <input type="text" class="col-sm-12 control-label" id="txtUUID" name="txtUUID" placeholder="Escriba UUID búscado">
                                    </div>
                                </div>

                                <div class="form-group" id="FInicial">
                                    <div class="col-sm-12">
                                     <!--####################################################################################################################-->
                                                                <div id="example">
                                                                    <div class="demo-section k-content">
                                                                        <label for="lbl_FechaInicial" class="col-sm-8 control-label">Fecha Inicial </label>
                                                                        <input id="start" style="width: 80%;"  />
                                                                        <label for="lbl_FechaFinal" class="col-sm-8 control-label">Fecha Final </label>
                                                                        <input id="end" style="width: 80%;" />
                                                                    </div>
                                                                    <script>
                                                                     $(document).ready(function() {
                                                                      function startChange() {
                                                                       var startDate = start.value(),
                                                                       endDate = end.value();

                                                                       if (startDate) {
                                                                        startDate = new Date(startDate);
                                                                        startDate.setDate(startDate.getDate());
                                                                        end.min(startDate);
                                                                       } else if (endDate) {
                                                                        start.max(new Date(endDate));
                                                                       } else {
                                                                        endDate = new Date();
                                                                        start.max(endDate);
                                                                        end.min(endDate);
                                                                       }
                                                                      }

                                                                      function endChange() {
                                                                       var endDate = end.value(),
                                                                       startDate = start.value();

                                                                       if (endDate) {
                                                                        endDate = new Date(endDate);
                                                                        endDate.setDate(endDate.getDate());
                                                                        start.max(endDate);
                                                                       } else if (startDate) {
                                                                        end.min(new Date(startDate));
                                                                       } else {
                                                                        endDate = new Date();
                                                                        start.max(endDate);
                                                                        end.min(endDate);
                                                                       }
                                                                      }

                                                                      var start = $("#start").kendoDatePicker({
                                                                       change: startChange,culture: "es-MX",
                                                                       parseFormats:["dd/MM/yyyy"],
                                                                       format: "dd/MM/yyyy"
                                                                      }).data("kendoDatePicker");

                                                                      var end = $("#end").kendoDatePicker({
                                                                       change: endChange,culture: "es-MX",
                                                                       parseFormats:["dd/MM/yyyy"],
                                                                       format: "dd/MM/yyyy"
                                                                      }).data("kendoDatePicker");

                                                                      start.max(end.value());
                                                                      end.min(start.value());
                                                                     });
                                                                    </script>

                                                                </div>
                                     <!--####################################################################################################################-->
                                    </div>
                                </div>

                                <div class="form-group">
                                           <div class="col-sm-8">
                                                     <!--<input class="magic-checkbox" name="aplicarFechas" id="aplicarFechas" value="1" type="checkbox">-->
                                                      <input type="checkbox" id="aplicarFechas" name="aplicarFechas"/>
                                                     <label for="aplicarFechas">Filtro de fechas</label>
                                                     <div id="txtAge" style="display:none" class="btn btn-success btn-xs">Activo</div>
                                           </div>
                                 </div>

                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <div class="form-group">
                                    <div class="col-sm-12">
                                        <p class="help-block">Seleccione los filtros y después presione Buscar.</p>

                               <div class="panel-body" >
                                <div class="tab-wrapper tab-primary">
                                    <ul class="nav nav-tabs">
                                        <li class="active"><a href="#home1" data-toggle="tab">Facturas verificadas PO's - SA's</a>
                                        </li>
                                        <li><a href="#profile1" data-toggle="tab">Archivos almacenados</a>
                                        </li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane active" id="home1">
                                                  <div class="panel-body">
                                                         <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#demo" aria-expanded="false">
                                                            Instrucciones
                                                         </button>
<!--                                                  <button id="xmlexpress" type="button" class="btn btn-info btn-3d" onclick="disparaDescargaA();">
                                                            Descargar
                                                        </button>-->
                                                          <button id="xmlexpress" class="btn btn-success" type="button" onclick="disparaDescargaA();"><i class="fa fa-cloud-download"></i> Descargar XML's</button>

                                                        <div id="demo" class="collapse in" aria-expanded="false" style="">

                                                            <div class="panel panel-default">
                                                                <div class="panel-body">
                                                                  <p>Para realizar la descarga de archivos capturados a través de procesos de verificación-recepción de facturas como por ejemplo en PO's , SA's, etc. que le devolverá los XML´s y un archivo complementario  en su versión en PDF, bastará con proporcionar el número de 1 sola Orden de Compra o bien el RFC del proveedor deseado, se sugiere delimitar la búsqueda estableciendo un perido de fechas específico. La descarga será en un archivo compreso en formato .RAR en la ubicación C:\Temp</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                        </div>
                                        <div class="tab-pane" id="profile1">
                                                     <div class="panel-body">
                                                        <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#demo1" aria-expanded="false">
                                                            Instrucciones
                                                        </button>
                                                        <button class="btn btn-info" type="button"  id="btnBuscar" name="btnBuscar" data-toggle="tooltip" data-placement="bottom" title="Buscar información con estos filtros"><i class="fa fa-search"></i>Buscar</button>
                                                         <button class="btn btn-success" type="button" id="btnAlmacenar" name="btnAlmacenar" data-toggle="tooltip" data-placement="bottom" title="Almacenar un archivo" ><i class="icon-paper-clip"></i> Almacenar</button>
                                                        <div id="demo1" class="collapse in" aria-expanded="false" style="">
                                                            <div class="panel panel-default">
                                                                <div class="panel-body">
                                                                    <p>Existen archivos complementarios almacenados que no son facturas XML procesadas por este Portal, sin embargo podran </p>
                                                                    <p>ser consultados y descargados, para ello proporcione al menos uno de los filtros y observe que en ocasiones la combinación </p>
                                                                    <p>de ellos puede o no devolver resultados, se sugiere delimitar la búsqueda estableciendo un perido de fechas específico. </p>
                                                                     <p>La descarga será en un archivo compreso en formato .RAR en la ubicación C:\Temp</p>
                                                                </div>
                                                            </div>

                                                                  <div id="CarteraVencida">
                                                                      <div class="col-md-12">
                                                                          <div class="panel panel-default">
                                                                              <div class="panel-heading">
                                                                                  <h3 class="panel-title">Archivos almacenados</h3>
                                                                                  <div class="actions pull-right">
                                                                                      <i class="fa fa-expand"></i>
                                                                                      <i class="fa fa-chevron-down"></i>
                                                                                      <i class="fa fa-times"></i>
                                                                                  </div>
                                                                              </div>
                                                                              <div class="panel-body">
                                                                                  <div id="Cuerpo">
                                                                                      <div class="form-group" style="height:350px">

                                                                                        <div class="box-col">
                                                                                            <button class='export-pdf k-button' style="visibility:hidden"></button>
                                                                                            <button type="button" class="btn btn-info" id="btnBajarRFC"><i class="fa fa-info-circle"></i>1 ) Recopilar los archivos del RFC </button>
                                                                                            <button type="button" class="btn btn-info" id="btnDescargaRFC"><i class="fa fa-info-circle"></i>2 ) Descargar los archivos del RFC </button>
                                                                                        </div>

                                                                                          <div class="panel panel-primary">
                                                                                          @(Html.Kendo().Notification()
                                                                                              .Name("popupNotification")
                                                                                              .Events(e => e.Show("onShow"))
                                                                                              )
                                                                                           @(Html.Kendo().Notification()
                                                                                               .Name("notification")
                                                                                               .Position(p => p.Pinned(true).Top(30).Right(30))
                                                                                               .Stacking(NotificationStackingSettings.Down)
                                                                                               .AutoHideAfter(0)
                                                                                               .Templates(t =>
                                                                                               {
                                                                                                   t.Add().Type("upload-success").ClientTemplateID("successTemplate");
                                                                                               })
                                                                                           )
                                                                                           @(Html.Kendo().Notification()
                                                                                               .Name("descargado")
                                                                                               .Position(p => p.Pinned(true).Top(30).Right(30))
                                                                                               .Stacking(NotificationStackingSettings.Down)
                                                                                               .AutoHideAfter(0)
                                                                                               .Templates(t =>
                                                                                               {
                                                                                                   t.Add().Type("upload-success").ClientTemplateID("successDescargado");
                                                                                               })
                                                                                           )
                                                                                          </div>

                                                                                       <div class="demo-section content-wrapper wide">
                                                                                          <div class="table-responsive"  id="conDatos">
                             
                                                                                              @(Html.Kendo().Grid<ClickFactura_Entidades.BD.Modelos.repositorioArchivosModel>()
                                                                                                                  .Name("rg")
                                                                                                                  .DataSource(dataSource => dataSource
                                                                                                                  .Ajax()
                                                                                                                  .PageSize(20))
                                                                                                                 .Pdf(pdf => pdf
                                                                                                                            .PaperSize("Letter")
                                                                                                                            .Margin("2cm", "1cm", "1cm", "1cm")
                                                                                                                            .FileName("Repositorio_Archivos.pdf")
                                                                                                                            .ProxyURL(Url.Action("Pdf_Export_Save", "Grid"))
                                                                                                                        )
                                                                                                                  .Columns(columns =>
                                                                                                                  {
                                                                                                                      columns.Bound(p => p.R4).Title("<strong>Nombre</strong>").Width(300);
                                                                                                                      columns.Bound(p => p.R2).Title("<strong>No. proveedor</strong>").Width(180);
                                                                                                                      columns.Bound(p => p.R6).Title("<strong>Emisor</strong>").Width(180);
                                                                                                                      columns.Bound(p => p.R15).Title("<strong>Sociedad</strong>").Width(160);
                                                                                                                      columns.Bound(p => p.R8).Title("<strong>UUID.</strong>").Width(350);
                                                                                                                      columns.Bound(p => p.R19).Title("<strong>Orden C.</strong>").Width(190);
                                                                                                                      columns.Bound(p => p.R18).ClientTemplate("<img src='" + Url.Content("../Images/bafar/download.png") + "' alt='Su archivo puede descargarse...' height='40' width='40' />").Width(120).Title("Descargar");
                                                                                                                  })
                                                                                                                  .HtmlAttributes(new { style = "height:349px;" })
                                                                                                                  .Pageable(pageable => pageable
                                                                                                                  .Messages(messages => messages
                                                                                                                  .Display("Registro {0} de {1}. Total de registros: {2}")
                                                                                                                  .First("Primera página")
                                                                                                                  .Next("Siguiente página")
                                                                                                                  .Previous("Página anterior")
                                                                                                                  .Last("Última página")
                                                                                                                  .Page("Página actual")
                                                                                                                  .MorePages("Más páginas")
                                                                                                                  .Empty("No se encontraron registros.")))
                                                                                                                  .Selectable(selectable => selectable
                                                                                                                  .Mode(GridSelectionMode.Multiple)
                                                                                                                  .Type(GridSelectionType.Row))
                                                                                                                  .Sortable()
                                                                                                                  .Scrollable()
                                                                                                                  .Events(x => x.Change("Grid_OnRowSelectUID"))
                                                                                                                  .Resizable(resize => resize.Columns(true))
                                                                                                                  .Filterable(ftb => ftb.Mode(GridFilterMode.Row))
                                                                                                                  .ToolBar(tools => tools.Excel())
                                                                                                                  .Excel(excel => excel
                                                                                                                              .FileName("CarteraVencida.xlsx")
                                                                                                                              .Filterable(true)
                                                                                                                              .ProxyURL(Url.Action("Excel_Export_Save", "repositorioArchivos"))
                                                                                                                              )
                                                                                              )
                                                                                          </div>
                                                                                       </div>
 
                                                                                          <div class="alert alert-danger fade in" id="sinDatos">
                                                                                                  <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                                                                                                  <h2>La consulta no devolvío información!</h2>
                                                                                                  <p>Con los filtros proporcionados no hubo resultados en el portal.Intente cambiando los criterios</p>
                                                                                           </div>
                                                                                      </div>
                                                                                  </div>
                                                                              </div>
                                                                          </div>
                                                                      </div>
                                                                  </div>




                                                        </div>
                                                    </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
<!--                                  <button type="button" class="btn btn-info btn-3d" id="btnBuscar" name="btnBuscar" data-toggle="tooltip" data-placement="bottom" title="Buscar información con estos filtros"><i class="icon-magnifier"></i>Buscar</button>
                                        <button type="button" class="btn btn-success btn-3d" id="btnAlmacenar" name="btnAlmacenar" data-toggle="tooltip" data-placement="bottom" title="Almacenar un archivo" ><i class="icon-paper-clip"></i>Almacenar</button>-->
                                        <button type="button" class="btn btn-primary" id="btnMuestraModalFechas" name="btnMuestraModalFechas" data-toggle="modal" data-target="#basicModal" style="visibility:hidden"><i class="icon-shuffle" ></i>Periodo fechas</button>
                                         <button id="showPopupNotification" class="k-button" style="height:0px; width:0px;visibility:hidden"></button>
                                        <button id="showSuccessNotification" class="k-button" style="height:0px; width:0px;visibility:hidden"></button>
                                        <button id="showSuccessDescargado" class="k-button" style="height:0px; width:0px;visibility:hidden"></button>
                                        <button id="showSuccessNODescargado" class="k-button" style="height:0px; width:0px;visibility:hidden"></button>
                                        <button type="button" class="btn btn-primary" id="btnMuestraModalArchivos" name="btnMuestraModalArchivos" data-toggle="modal" data-target="#basicModalArchivos" style="visibility:hidden"><i class="icon-shuffle" ></i>Ventana archivos</button>
                                    </div>
                                    <br />
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>



     <div tabindex="-1" class="modal fade" id="basicModal" role="dialog" aria-hidden="true" aria-labelledby="myModalLabel" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button>
                    <h4 class="modal-title" id="myModalLabel">No hay periodo de fechas</h4>
                </div>
                <div class="modal-body">
                    <p>La opción de 'Filtro de fechas' esta desmarcada, esto indica al portal buscar información desde su inicio de operaciones.</p>
                    <p> El volúmen de información podría ser tán grande que la respuesta podria tardar demasiado, ¿Esta seguro de continuar sin periodo de fechas?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success btn-square" type="button"  id="btnContinuar" data-dismiss="modal" name="btnContinuar">Continuar</button>
                    <button class="btn btn-default btn-trans" data-dismiss="modal" type="button">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

      <div tabindex="-1" class="modal fade" id="basicModalArchivos" role="dialog" aria-hidden="true" aria-labelledby="myModalLabel" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button>
                    <h4 class="modal-title" id="myModalLabel">Descarga de archivos</h4>
                </div>
                <div class="modal-body">
                    <!--<p>Hemos identificado el tipo de archivo como </p>-->
                    <p> ¿Desea descargar los archivos encontrados en el listado inferior? </p>
                 <!--<button id="archivo "type="button" class="btn btn-info btn-3d">Según tipo de archivo</button>-->
                 <button id="xml" type="button" class="btn btn-info btn-3d" onclick="disparaDescargaA();">XML´s y PDF´s</button>
                 <!--<button id="conPDF" type="button" class="btn btn-info btn-3d">EL XML y su PDF</button>-->
                </div>
                <div class="modal-footer">
                    <!--<button class="btn btn-success btn-square" type="button"  id="btnContinuar" name="btnContinuar">Continuar</button>-->
                    <button class="btn btn-default btn-3d" data-dismiss="modal" type="button">Listo!</button>
                </div>
            </div>
        </div>
    </div>

      <div tabindex="-1" class="modal fade" id="basicModalAlmacena" role="dialog" aria-hidden="true" aria-labelledby="myModalLabel" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button>
                    <h4 class="modal-title" id="myModalLabel">Zona de carga</h4>
                </div>
                <div class="modal-body">
                    <p>Desplace los archivos hacia esta ventana para ser  pre-cargados. Una vez agregados a esta ventana confirme presionando 'Guardar'.</p>
                </div>
             <!--##################################################################################################################################################-->
               <div class="container kv-main" style="height:250px">
                                            <div class="form-group">
                                            <div class="file-input file-input-ajax-new"><div class="file-preview ">
                                             <div class="close fileinput-remove">×</div>
                                             <div class=" file-drop-zone"><div class="file-drop-zone-title">Drag &amp; drop files here …</div>
                                             <div class="file-preview-thumbnails">
                                             </div>
                                             <div class="clearfix"></div>    <div class="file-preview-status text-center text-success"></div>
                                             <div style="display: none;" class="kv-fileinput-error file-error-message"></div>
                                             </div>
                                         </div>
                                         <div class="kv-upload-progress hide"><div class="progress">
                                             <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%;">
                                                 0%
                                              </div>
                                         </div></div>
                                         <div class="input-group file-caption-main">
                                            <div tabindex="500" class="form-control file-caption  kv-fileinput-caption">
                                            <div class="file-caption-name"></div>
                                         </div>

                                            <div class="input-group-btn">
                                                <button type="button" tabindex="500" title="Clear selected files" class="btn btn-default fileinput-remove fileinput-remove-button"><i class="glyphicon glyphicon-trash"></i>  <span class="hidden-xs">Remove</span></button>
                                                <button type="button" tabindex="500" title="Abort ongoing upload" class="btn btn-default hide fileinput-cancel fileinput-cancel-button"><i class="glyphicon glyphicon-ban-circle"></i>  <span class="hidden-xs">Cancel</span></button>
                                                <a href="#" tabindex="500" title="Upload selected files" class="btn btn-default fileinput-upload fileinput-upload-button"><i class="glyphicon glyphicon-upload"></i>  <span class="hidden-xs">Upload</span></a>
                                                <div tabindex="500" class="btn btn-primary btn-file"><i class="glyphicon glyphicon-folder-open"></i>&nbsp;  <span class="hidden-xs">Browse …</span><input id="file-4" class="file" data-upload-url="#" type="file"></div>
                                            </div>
                                         </div>
                                       </div>
                                      </div>
                                      <div class="modal-footer">
                                                       <button class="btn btn-success btn-square" type="button"  id="btnContinuarAlmacena" data-dismiss="modal" name="btnContinuar">Guardar</button>
                                                       <button class="btn btn-default btn-trans" data-dismiss="modal" type="button">Cancelar</button>
                                      </div>
           </div>

                    </div>
          </div>
             <!--##################################################################################################################################################-->
         </div>


  <div id="Complementos" style="visibility:hidden" >
               <script id="successTemplate" type="text/x-kendo-template">        
                <div class="upload-success">
                    <img src="../Images/bafar/correctCirculoBlanco.png" width="250" height="70"/>
                </div>
            </script>
                  <script id="successDescargado" type="text/x-kendo-template">        
                  <div class="upload-success">
                      <img src="../Images/bafar/archivoDescargadoCorrectamente.png" width="250" height="70"/>
                  </div>
            </script>
                  <script id="successNODescargado" type="text/x-kendo-template">        
                  <div class="upload-success">
                      <img src="../Images/bafar/archivoNODescargado.png" width="250" height="70"/>
                  </div>
           </script>
 </div>

  <!--#################################################    VENTANA AUXILIAR #####################################################################-->
        <div id="exampleWindow" style="visibility:hidden">
            <div id="window">
   <!--             <div class="armchair"><img src="../content/web/window/armchair-402.png" alt="Window de prueba" />Zona de carga</div>-->
            </div>

            <span id="undo" style="display:none" class="k-button hide-on-narrow">Abrir almacenamiento interno</span>

            <div class="responsive-message"></div>
            
<!--    <script>
             //$(document).ready(function () {
             // var myWindow = $("#window"),
             //     undo = $("#undo");

             // undo.click(function () {
             //  myWindow.data("kendoWindow").open();
             //  undo.fadeOut();
             // });

             // function onClose() {
             //  undo.fadeIn();
             // }
             //});
    </script>-->

    <style>
                #exampleWindow
                {
                    min-height:800px;
                }
                #undo {
                    text-align: center;
                    position: absolute;
                    white-space: nowrap;
                    padding: 1em;
                    cursor: pointer;
                }
                .armchair {
                	float: left;
                	margin: 30px 30px 120px 30px;
                	text-align: center;
                }
                .armchair img {
                    display: block;
                    margin-bottom: 10px;
                }        
            </style>

        </div>


 <!--#################################################    VENTANA AUXILIAR #####################################################################-->

</form>

<!-- G L O B A L-->
<script type="text/javascript">
 var url_dir = '@System.Configuration.ConfigurationManager.AppSettings["dirImagenTMS"].ToString()';

 $(document).ready(function () {
  cargaSociedades();
  ConfiguraCalendarios();
  $("#sinDatos").hide();

  $("#btnBuscar").click(function (e) {
   disparaCargar();
  });

  $("#btnContinuar").click(function (e) {
   disparaContinuar();
  });

  $("#btnAlmacenar").click(function (e) {
   var url = $("#RedirectToAlmacenamientoInterno").val();
   location.href = url;
  });

  $("#btnBajarRFC").click(function (e) {
   var rfc = $("#txtRFC_Proveedor").val();
   var numproveedor = $("#txtNum_Proveedor").val();
   var sociedad = $("#Sociedades").val();
   var _finicial = $("#start").val();
   var ffinal = $("#end").val();
   //data: {'rfc': rfc,'aplicarfechas':aplicarFechas,'finicial':_finicial,'ffinal':ffinal,'numproveedor':numproveedor},
        var aplicarFechas = $('#txtAge').is(':visible');
        $.ajax
                 (
                    {
                          type: "post",
                          url: url_dir + '/repositorioArchivos/bajaTodoRFC',
                          data: {'rfc': rfc,'aplicarfechas':aplicarFechas,'finicial':_finicial,'ffinal':ffinal},
                          cache: false,
                          success: function (resultadoRFC) {
                                          if (resultadoRFC!= null) {
                                           if (resultadoRFC[0].R1 == 'hecho') {
                                            alert('Generados');
                                            descargaArchivos(resultadoRFC);
                                           }
                                           else
                                            $("#showSuccessNODescargado").click();
                                          }
                          }
                    }
                 );
  });

  $("#btnDescargaRFC").click(function (e) {
   var _url = '@Url.Action("recuperaArchivosZip", "repositorioArchivos")';
   $.ajax
       (
          {
           type: "post",
           url: _url,
           data: {},
           cache: false,
           success: function (resultadosRFC) {
            if (resultadosRFC != null) {
             if (resultadosRFC[0].R1 == 'correcto') {
              descargaArchivos(resultadosRFC);
             }
             else
              $("#showSuccessNODescargado").click();
            }
           }
          }
       );
     });

  $('#aplicarFechas').click(function () {
  $("#txtAge").toggle(this.checked);
  });

  var now = new Date();
  var day = ('0' + now.getDate()).slice(-2);
  var month = ('0' + (now.getMonth() + 1)).slice(-2);

  var inicial = '01/' + month + '/' + now.getFullYear();
  var final = (day)+'/'+(month)+'/'+now.getFullYear() ;

  $('#start').val(inicial);
  $('#end').val(final);
  //#############################################
  var popupNotification = $("#popupNotification").data("kendoNotification");
  $("#showPopupNotification").click(function () {
   var d = new Date();
   popupNotification.show('No se encontraron resultados a la consulta '+kendo.toString(d, 'HH:MM:ss.') + kendo.toString(d.getMilliseconds(), "000"), "error");
   return false;
  });

  var notification = $("#notification").data("kendoNotification");
  $("#showSuccessNotification").click(function () {
   notification.show({
    message: "Upload Successful"
   }, "upload-success");
   return false;
  });

  var donwload = $("#descargado").data("kendoNotification");
  $("#showSuccessDescargado").click(function () {
   donwload.show({
    message: "Archivo descargado"
   }, "upload-success");
   return false;
  });

  //var NOdonwload = $("#Nodescargado").data("kendoNotification");
  //$("#showSuccessNODescargado").click(function () {
  // NOdonwload.show({
  //  message: "Archivo No descargado"
  // }, "upload-success");
  // return false;
  //});
  //#############################################

  var comboboxEstatus = $("#estatus").data("kendoComboBox");

  $(".export-pdf").click(function () {
   // Convert the DOM element to a drawing using kendo.drawing.drawDOM
   kendo.drawing.drawDOM($(".content-wrapper"))
   .then(function (group) {
    // Render the result as a PDF file
    return kendo.drawing.exportPDF(group, {
     paperSize: "auto",
     margin: { left: "1cm", top: "1cm", right: "1cm", bottom: "1cm" }
    });
   })
   .done(function (data) {
    // Save the PDF file
    kendo.saveAs({
     dataURI: data,
     fileName: "HR-Dashboard.pdf",
     proxyURL: "Pdf_Export_Save"
    });
   });
   return false;
  });

 });
 

 function llamaDescargaIndividual()
 {
  var _url = '@Url.Action("recuperaArchivosZip", "repositorioArchivos")';
  $.ajax
      (
         {
          type: "post",
          url: _url,
          data: {},
          cache: false,
          success: function (resultadounXML) {
                          if (resultadosRFC != null) {
                           if (resultadosRFC[0].R1 == 'correcto') {
                                    descargaArchivos(resultadosRFC);
                           }
                           else
                            $("#showSuccessNODescargado").click();
                          }
          }
         }
      );
 }

 function descargaArchivos(Archivos)
 {
          for (i = 0; i < Archivos.length; i++) {
             var res = String.fromCharCode(92);
             var url = Archivos[i].R2;
             var fileName = url.substring(url.lastIndexOf(res) + 1);
             var blobData = new Blob([Archivos[i].RByte]);
               try {
                        ///-----------------------------------------------------------------------------
                         var arr = Archivos[i].RByte;
                         var byteArray = new Uint8Array(arr);
                         var csvData = new Blob([byteArray], { type: 'text/csv;charset=utf-8;' });
                          //IE11 & Edge
                          if (navigator.msSaveBlob) {
                           navigator.msSaveBlob(csvData, fileName);
                         }
                         else
                          {
                           //In FF link must be added to DOM to be clicked
                           var link = document.createElement('a');
                           link.href = window.URL.createObjectURL(csvData);
                           link.setAttribute('download', fileName);
                           document.body.appendChild(link);
                           link.click();
                           document.body.removeChild(link);
                          }
                        ///-----------------------------------------------------------------------------
             }
           catch (error)
                 {
                 $("#showSuccessNODescargado").click();
                 }
            }
 }

 function disparapasaID(currentDataItem,url_DIR)
 {
  try
  {
   var _url = '@Url.Action("pasaIdAlmacenado", "repositorioArchivos")';
      $.ajax
      ({
       type: "post",
       url: _url,
       data: { 'id': currentDataItem },
       cache: false,
       beforeSend: function () {
        //   imagen de carga
         alert("enviando!...");
       },
       error: function (jqXHR, exception) {
        if (jqXHR.status === 0) {
         alert('Not connect.\n Verify Network.');
        } else if (jqXHR.status == 404) {
         alert('Requested page not found. [404]');
        } else if (jqXHR.status == 500) {
         alert('Internal Server Error [500].');
        } else if (exception === 'parsererror') {
         alert('Requested JSON parse failed.');
        } else if (exception === 'timeout') {
         alert('Time out error.');
        } else if (exception === 'abort') {
         alert('Ajax request aborted.');
        } else {
         alert('Uncaught Error.\n' + jqXHR.responseText);
        }
       },
       success: function (resultadounXML) {
        if (resultadounXML != null) {
         if (resultadounXML[0].R1 == 'correcto')
         {
             descargaArchivos(resultadounXML);
         }
         else
          $("#showSuccessNODescargado").click();
        }
        else
         $("#showSuccessNODescargado").click();
       }
   });
     
  }
  catch (error)
  {
       $("#showSuccessNODescargado").click();
  }
 }

 function cargaSociedades() {
  $.ajax({
   type: "post",
   url: url_dir + '/repositorioArchivos/GetSociedades',
   data: { 'esAdmon': 'No' },
   cache: false,
   success: function (lista) {
    var combo = $("#Sociedades");
    for (var i = 0; i < combo.length; i++) {
     var ele = combo[i];
     var total = ele.length;
     if (total > 0) {
      for (var j = total - 1; j >= 0; j--) {
       ele.remove(j);
      }
     }
    }
    combo.append("<option value='0'>Seleccione una Sociedad</option>");
    for (var i = 0; i < lista.length; i++) {
     combo.append("<option value='" + lista[i].Num_Sociedad + "'>" + lista[i].Compania + "</option>");
    }
   }
  });
 }
 
 function disparaCargar() {
  var numproveedor = $("#txtNum_Proveedor").val();
  var sociedad = $("#Sociedades").val();
  var _finicial = $("#start").val();
  var ffinal = $("#end").val();
  var ordencompra = $("#txtOrdenCompra").val();
  var rfc = $("#txtRFC_Proveedor").val();
  var estatus = $("#estatus").val();
  var nombrearchivo = $("#txtNombre").val();

  //##############################################################################

  //##############################################################################

  var aplicarFechas = $('#txtAge').is(':visible');
  if (aplicarFechas == false)
      {
           $("#btnMuestraModalFechas").click();
      }
      else
      {
          CargaResultados(sociedad, ordencompra, _finicial, ffinal, numproveedor,rfc,aplicarFechas,estatus,nombrearchivo);
      }

 }

 function disparaContinuar() {
  var numproveedor = $("#txtNum_Proveedor").val();
  var sociedad = $("#Sociedades").val();
  var _finicial = $("#start").val();
  var ffinal = $("#end").val();
  var ordencompra = $("#txtOrdenCompra").val();
  var rfc = $("#txtRFC_Proveedor").val();
  var estatus = $("#estatus").val();
  var nombrearchivo = $("#txtNombre").val();
   CargaResultados(sociedad, ordencompra, _finicial, ffinal, numproveedor, rfc, false, estatus, nombrearchivo);
 }

 function CargaResultados(sociedad, ordencompra, _finicial, ffinal, numproveedor, rfc, aplicarFechas, estatus, nombrearchivo) {
  $("#Cuerpo").removeClass('class="alert alert-danger"');
  $.ajax
   (
       {
        type: "post",
        url: url_dir + '/repositorioArchivos/CargaResultadosrepositorioArchivos',
        data: { 'numProveedor': numproveedor, 'finicial': _finicial, 'ffinal': ffinal, 'ordencompra': ordencompra, 'sociedad': sociedad,'rfc':rfc,'aplicarfechas':aplicarFechas,'estatus':estatus,'nombrearchivo':nombrearchivo },
        cache: false,
        success: function (lista) {
         if (lista.length == 0) {
                  noSeEncontroFO = true;
                 $("#conDatos").hide();
                 $("#sinDatos").show();
                 $("#showPopupNotification").click();
         }
         else {
          CargarGrid(lista);
          $("#sinDatos").hide();
          $("#conDatos").show();
          $("#showSuccessNotification").click();
         }
        }
       }
    );
 }

 function CargarGrid(lista) {
  var grid = $("#rg").data("kendoGrid");
  var dataSource = new kendo.data.DataSource(
       {
        data: lista,
        pageSize: 20
       })
  ;
  grid.setDataSource(dataSource);
  grid.refresh();
 }

 function ConfiguraCalendarios()
 {
  var ini = $("#start").val();
  var fin = $("#end").val();
  $.ajax
 (
     {
      type: "post",
      url: url_dir + '/repositorioArchivos/ConfiguraCalendarios',
      data: {},
      cache: false,
      success: function (fechas) {
       $("#start").value = fechas[0];
       $("#end").value = fechas[1];
       $("#start").text = fechas[0];
       $("#end").text = fechas[1];
      }
     }
  );
 }

 function onShow(e) {
  if (!$("." + e.sender._guid)[1]) {
   var element = e.element.parent(),
     eWidth = element.width(),
     eHeight = element.height(),
     wWidth = $(window).width(),
     wHeight = $(window).height(),
     newTop, newLeft;

   newLeft = Math.floor(wWidth / 2 - eWidth / 2);
   newTop = Math.floor(wHeight / 2 - eHeight / 2);

   e.element.parent().css({ top: newTop, left: newLeft });
  }
 }

 function preparaDescarga(id)
 {

  $("#btnMuestraModalArchivos").click(); 
}

 function disparaDescargaA()
 {
  $(document).ajaxStart(
                   $.blockUI({
                    message: '<h1><img src="' + loading + '" /> Buscando XML...</h1>',
                    css: {
                     border: 'none',
                     padding: '15px',
                     backgroundColor: '#000',
                     '-webkit-border-radius': '10px',
                     '-moz-border-radius': '10px',
                     opacity: .5,
                     color: '#fff'
                    }
                   }))
                   .ajaxSend(
                       $.blockUI({
                        message: '<h1><img src="' + loading + '" /> Descargando XML...</h1>',
                        css: {
                         border: 'none',
                         padding: '15px',
                         backgroundColor: '#000',
                         '-webkit-border-radius': '10px',
                         '-moz-border-radius': '10px',
                         opacity: .5,
                         color: '#fff'
                        }
                       }))
                   .ajaxError($.unblockUI)
                   .ajaxComplete($.unblockUI)
                   .ajaxStop($.unblockUI);


  var ordencompra = $("#txtOrdenCompra").val();
  var rfc = $("#txtRFC_Proveedor").val();
  var ini = $("#start").val();
  var fin = $("#end").val();
  analizartipoArchivo(10, rfc, ordencompra, ini, fin);

 }

 function analizartipoArchivo(id,rfc,ordencompra,finicial,ffinal)
 {
  var ordencompra = $("#txtOrdenCompra").val();
  var rfc = $("#txtRFC_Proveedor").val();
  var ini = $("#start").val();
  var fin = $("#end").val();
  $.ajax
 (
     {
      type: "post",
      url: url_dir + '/repositorioArchivos/analizaArchivos',
      data: {'id':id,'rfc':rfc,'ordencompra':ordencompra,'finicial':finicial,'ffinal':ffinal},
      cache: false,
      success: function () {
       $("#showSuccessNotification").click();
      }
     }
  );
 }
  
 function Grid_OnRowSelectUID(e) {
  grid = e.sender;
  var url_DIR = '@System.Configuration.ConfigurationManager.AppSettings["dirImagenTMS"].ToString()';
  url_DIR=url_DIR + '/repositorioArchivos/pasaIdAlmacenado'
  var currentDataItem = "";
  try
  {
   currentDataItem=grid.dataItem(this.select()).R1;//Es el idAlmacenado
  }
  catch (err)
  {
   currentDataItem = "-1";
  }
  disparapasaID(currentDataItem,url_DIR);
 }



 function guardaItem(item) {
  $.ajax({
   type: "post",
   url: url_dir + '/repositorioArchivos/guardaItem',
   data: { 'item': item },
   cache: false,
   success: function (pass) {
   }
  });
 }

 function downloadFile(url, onSuccess,nombre) {
  var xhr = new XMLHttpRequest();
  xhr.onprogress = calculateAndUpdateProgress;
  xhr.open('GET', url, true);
  xhr.responseType = "blob";
  xhr.onreadystatechange = function () {
   if (xhr.readyState == 4) {
    if (onSuccess) onSuccess(xhr.response);
   }


   function blobToBase64(blob, callback) {
    var reader = new FileReader();
    reader.onload = function() {
     var dataUrl = reader.result;
     var base64 = dataUrl.split(',')[1];
     callback(base64);
    };
    reader.readAsDataURL(blob);
   }

  }
 }

 function calculateAndUpdateProgress(evt) {
   if (evt.lengthComputable) {
         // get download progress by performing some average 
         // calculations with evt.loaded, evt.total and the number
         // of file to download / already downloaded
        // then update the GUI elements (eg. page-action icon and popup if showed)
         var percentComplete = (evt.loaded / evt.total) * 100;
         console.log('Progreso actual.....', percentComplete);
   }
  }

 function descargaZIPByte(url, blobData) {
  var count = 0;
  if (count < url.length) {

   blobToBase64(blobData, function (binaryData) {
    // add downloaded file to zip:
    var zip = new JSZip();
    var fileName = url.substring(url[count].lastIndexOf('/') + 1);
    zip.file(fileName, binaryData, { base64: true });
    // all files have been downloaded, create the zip
    var content = zip.generate();

    // then trigger the download link:        
    var zipName = fileName+'.zip';
    var a = document.createElement('a');
    a.href = "data:application/zip;base64," + content;
    a.download = zipName;
    a.click();

   });
  }
 }

 function descargaZIPByteFinal(url, blobData) {
  var count = 0;
  if (count < url.length) {

   blobToBase64(blobData, function (binaryData) {
    // add downloaded file to zip:
    var zip = new JSZip();
    var fileName = url.substring(url[count].lastIndexOf('/') + 1);
    zip.file(fileName, binaryData, { base64: true });
    // all files have been downloaded, create the zip
    var content = zip.generate();

    return content;

   });
  }
 }

 function blobToBase64(blob, callback) {
  var reader = new FileReader();
  reader.onload = function () {
   var dataUrl = reader.result;
   var base64 = dataUrl.split(',')[1];
   callback(base64);
  };
  reader.readAsDataURL(blob);
 }

 function ajax_download(url, data, input_name) {
  var $iframe,
      iframe_doc,
      iframe_html;

  if (($iframe = $('#download_iframe')).length === 0) {
   $iframe = $("<iframe id='download_iframe'" +
               " style='display: none' src='about:blank'></iframe>"
              ).appendTo("body");
  }

  iframe_doc = $iframe[0].contentWindow || $iframe[0].contentDocument;
  if (iframe_doc.document) {
   iframe_doc = iframe_doc.document;
  }

  iframe_html = "<html><head></head><body><form method='POST' action='" +
                url + "'>" +
                "<input type=hidden name='" + input_name + "' value='" +
                JSON.stringify(data) + "'/></form>" +
                "</body></html>";

  iframe_doc.open();
  iframe_doc.write(iframe_html);
  $(iframe_doc).find('form').submit();
 }

</script>
  <!--columns.Bound(p => p.R18).ClientTemplate("<img src='" + Url.Content("../Imagenes/") + "#=R18#' alt='Su archivo..' height='40' width='40'/>").Width(120).Title("Descargar");-->
<!--Load these page level functions-->
@section Scripts {
   <!-- @Scripts.Render("~/Scripts/plugins/dropzone")-->
}

<script type="text/javascript">

</script>

<!--<script>
     kendo.pdf.defineFont({
      "DejaVu Sans": "//kendo.cdn.telerik.com/2014.3.1314/styles/fonts/DejaVu/DejaVuSans.ttf",
      "DejaVu Sans|Bold": "//kendo.cdn.telerik.com/2014.3.1314/styles/fonts/DejaVu/DejaVuSans-Bold.ttf",
      "DejaVu Sans|Bold|Italic": "//kendo.cdn.telerik.com/2014.3.1314/styles/fonts/DejaVu/DejaVuSans-Oblique.ttf",
      "DejaVu Sans|Italic": "//kendo.cdn.telerik.com/2014.3.1314/styles/fonts/DejaVu/DejaVuSans-Oblique.ttf"
     });
    </script>-->

<style>
        .k-grid {
            font-family: "DejaVu Sans", "Arial", sans-serif;
        }

        .k-pdf-export .k-grid-toolbar,
        .k-pdf-export .k-pager-wrap
        {
            display: none;
        }
</style>

